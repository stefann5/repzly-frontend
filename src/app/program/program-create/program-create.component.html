<!-- program-create.component.html -->
<div class="surface-ground px-0 py-2 md:px-4 md:py-5">
  <!-- Loading state -->
  <div *ngIf="loading" class="flex justify-content-center align-items-center">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <ng-container *ngIf="!loading">
    <!-- Header -->
    <div class="mb-3 flex md:justify-content-start justify-content-center align-items-center">
      <div class="text-2xl md:text-3xl font-bold">{{ getPageTitle() }}</div>
    </div>

    <form [formGroup]="programForm" (ngSubmit)="onSubmit()" (keydown.enter)="preventEnterKeySubmission($event)">
      <p-stepper [value]="activeStep" [linear]="true" class="w-full">
        <!-- Step List -->
        <p-step-list>
          <p-step [value]="1">Program Info</p-step>
          <p-step [value]="2">Workout Structure</p-step>
          <p-step [value]="3">Review & {{ isEditMode ? 'Update' : 'Create' }}</p-step>
        </p-step-list>

        <!-- Step Panels -->
        <p-step-panels>
          <!-- Step 1: Program Info -->
          <p-step-panel [value]="1">
            <ng-template #content let-activateCallback="activateCallback">
              <div class="surface-card p-4 border-round shadow-2 mb-4">
                <div class="p-fluid">
                  <!-- Program Name -->
                  <div class="field mb-4">
                    <label for="name" class="text-900 font-medium mb-2 block">Program Name</label>
                    <span class="p-input-icon-left w-full">
                      <input id="name" type="text" pInputText formControlName="name" placeholder="Enter program name"
                        class="w-full">
                    </span>
                    <small class="p-error text-red-400 block mt-1"
                      *ngIf="programForm.get('name')?.invalid && (programForm.get('name')?.touched || programForm.get('name')?.dirty)">
                      {{ getErrorMessage(programForm.get('name'), 'Program name') }}
                    </small>
                  </div>

                  <!-- Program Description -->
                  <div class="field mb-4">
                    <label for="description" class="text-900 font-medium mb-2 block">Program Description</label>
                    <span class="p-input-icon-left w-full">
                      <textarea id="description" pTextarea formControlName="description" [rows]="3"
                        placeholder="Enter program description" class="w-full"></textarea>
                    </span>
                  </div>

                  <!-- Visibility Toggle -->
                  <div class="field mb-4">
                    <label class="text-900 font-medium mb-2 block">Visibility</label>
                    <p-selectButton [options]="publicOptions" formControlName="public" optionLabel="label"
                      optionValue="value" styleClass="w-full md:w-auto">
                    </p-selectButton>
                  </div>

                  <!-- Program Image -->
                  <div class="field">
                    <div class="flex justify-content-center align-items-center">
                      <p-fileUpload id="programImage" mode="basic" chooseLabel="Select Image" accept="image/*"
                        [auto]="true" [maxFileSize]="256000" (onSelect)="onImageUpload($event)"
                        [showCancelButton]="false" styleClass="w-full" fileLimit="1"></p-fileUpload>
                    </div>

                    <!-- Image Preview Section -->
                    <div
                      *ngIf="(imagePreviewUrl || existingImageUrl) && (uploadedImage || (existingImageUrl && !imageChanged))"
                      class="mt-4 flex justify-content-center">
                      <div class="flex flex-column align-items-center">
                        <div class="relative">
                          <img [src]="imagePreviewUrl || existingImageUrl" class="shadow-2 border-round"
                            style="max-width: 100%; max-height: 250px; object-fit: cover;">
                          <button pButton type="button" icon="pi pi-times"
                            class="p-button-rounded p-button-danger p-button-text absolute top-0 right-0"
                            (click)="removeImage()"></button>
                        </div>
                        <small *ngIf="uploadedImage" class="mt-2 text-600 text-center">
                          {{ uploadedImage.name }} ({{ formatFileSize(uploadedImage.size || 0) }})
                        </small>
                        <small *ngIf="existingImageUrl && !imageChanged" class="mt-2 text-600 text-center">Current
                          image</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Navigation Button -->
              <div class="flex justify-content-end mt-4">
                <p-button label="Next" icon="pi pi-arrow-right" iconPos="right"
                  (onClick)="handleNextFromStep1(activateCallback)" styleClass="p-button-raised mr-2"></p-button>
              </div>
            </ng-template>
          </p-step-panel>

          <p-step-panel [value]="2">
            <ng-template #content let-activateCallback="activateCallback">


              <p-tabs [value]="activeWeekTab" formArrayName="weeks" scrollable (onChange)="onTabChange($event)">
                <div class="flex justify-content-end mb-2">
                  <button pButton type="button" label="Add Week" icon="pi pi-plus" class="p-button-outlined mr-2"
                    (click)="addWeek()"></button>
                  <button pButton type="button" label="Paste Week" icon="pi pi-file-import"
                    class="p-button-outlined mr-2" (click)="pasteWeek()" [disabled]="!copiedWeek || pasteWeekLoading"
                    [loading]="pasteWeekLoading">
                  </button>
                </div>

                <p-tablist #tablist>
                  <p-tab *ngFor="let week of weeks.controls; let i = index" [value]="i.toString()">
                    <div class="flex justify-content-between align-items-center">
                      <h4 class="m-0">Week {{ i + 1 }}</h4>
                      <div>
                        <!-- In your template -->
                        <button pButton type="button" icon="pi pi-copy" class="p-button-rounded p-button-text"
                          pTooltip="Copy Week" severity="contrast"
                          (click)="$event.stopImmediatePropagation(); copyWeek(i, $event); false"></button>

                        <button pButton type="button" icon="pi pi-times" class="p-button-rounded p-button-text"
                          pTooltip="Remove Week" severity="contrast"
                          (click)="$event.stopImmediatePropagation(); removeWeek(i, $event); false"
                          [disabled]="weeks.length <= 1"></button>
                      </div>
                    </div>
                  </p-tab>
                </p-tablist>

                <p-tabpanels class="p-0">
                  <p-tabpanel *ngFor="let week of weeks.controls; let i = index" [value]="i.toString()">
                    <div [formGroupName]="i">
                      <!-- Workouts for this Week -->
                      <div formArrayName="workouts" class="w-full">
                        <p-accordion [value]="getActiveWorkoutAccordionIndex(i)">
                          @for (workout of getWorkouts(i).controls; track workout; let workoutIndex = $index) {
                          <p-accordion-panel [value]="workoutIndex" styleClass="mb-4 z-0">
                            <p-accordion-header>
                              <ng-template #toggleicon let-active="active">
                                @if (active) {
                                <i class=""></i>
                                } @else {
                                <i class=""></i>
                                }
                              </ng-template>
                              <div class="flex justify-content-between align-items-center p-2 w-full">
                                <div class="flex align-items-center">
                                  <span class="font-bold text-xl mr-2">{{workoutIndex + 1}}</span>
                                  <span class="text-xl">{{ workout.get('title')?.value || 'Workout' }}</span>
                                  <button pButton type="button" icon="pi pi-pencil" pTooltip="Edit Workout"
                                    class="p-button-rounded p-button-text ml-2"
                                    (click)="$event.stopPropagation(); openWorkoutEditDialog(i, workoutIndex)"></button>
                                </div>
                                <ng-container *ngIf="!showInputButtons; else workoutDesktopControls">
                                  <!-- Mobile Menu for Workouts -->
                                  <button pButton icon="pi pi-ellipsis-v" class="p-button-text p-button-rounded"
                                    (click)="$event.stopPropagation(); workoutMenu.toggle($event)"
                                    pTooltip="Workout Options" type="button">
                                  </button>
                                  <p-menu #workoutMenu [popup]="true" styleClass="overflow-visible"
                                    (click)="$event.stopPropagation();" [model]="getWorkoutMenuItems(i, workoutIndex)"
                                    appendTo="body"></p-menu>
                                </ng-container>
                                <ng-template #workoutDesktopControls>
                                  <!-- Desktop Buttons Layout -->
                                  <div class="flex">
                                    <button pButton type="button" icon="pi pi-copy"
                                      class="p-button-rounded p-button-text mr-1"
                                      (click)="$event.stopPropagation(); copyWorkout(i, workoutIndex)"
                                      pTooltip="Copy Workout"></button>
                                    <button pButton type="button" icon="pi pi-arrow-up" pTooltip="Move Workout Up"
                                      class="p-button-rounded p-button-text mr-1"
                                      (click)="$event.stopPropagation(); moveWorkoutUp(i, workoutIndex)"
                                      [disabled]="workoutIndex === 0"></button>
                                    <button pButton type="button" icon="pi pi-arrow-down" pTooltip="Move Workout Down"
                                      class="p-button-rounded p-button-text mr-1"
                                      (click)="$event.stopPropagation(); moveWorkoutDown(i, workoutIndex)"
                                      [disabled]="workoutIndex === getWorkouts(i).length - 1"></button>
                                    <button pButton type="button" icon="pi pi-times"
                                      class="p-button-rounded p-button-danger p-button-text" pTooltip="Remove Workout"
                                      (click)="$event.stopPropagation(); removeWorkout(i, workoutIndex)"
                                      [disabled]="getWorkouts(i).length <= 1"></button>
                                  </div>
                                </ng-template>
                              </div>
                            </p-accordion-header>
                            <p-accordion-content class="p-0">
                              <div [formGroupName]="workoutIndex"
                                class="surface-50 border-1 border-300 border-round mb-4">
                                <!-- Hidden form controls (not visible to user) -->
                                <div class="hidden">
                                  <input id="title{{i}}-{{workoutIndex}}" type="text" pInputText
                                    formControlName="title">
                                  <textarea id="description{{i}}-{{workoutIndex}}" pTextarea
                                    formControlName="description"></textarea>
                                </div>

                                <!-- Exercises Section -->
                                <div formArrayName="workoutExercises" class="">
                                  <!-- Exercise Cards -->
                                  <div
                                    *ngFor="let exercise of getWorkoutExercises(i, workoutIndex).controls; let exerciseIndex = index"
                                    class="surface-50 mb-3 border-bottom-1 surface-border">
                                    <div [formGroupName]="exerciseIndex">
                                      <!-- Exercise Details Card -->
                                      <div class="p-1">
                                        <!-- Exercise Selection and Delete Button -->
                                        <div class="grid">
                                          <div class="col-9 md:col-7 h-full">
                                            <p-select [id]="'exercise' + i + '-' + workoutIndex + '-' + exerciseIndex"
                                              formControlName="exercise" (onClick)="resetFilteredExercises()"
                                              [options]="getFilteredExercises(i, workoutIndex, exerciseIndex)"
                                              optionLabel="title" placeholder="Select an Exercise" [filter]="true"
                                              styleClass="w-full h-full justify-content-center align-items-center"
                                              [ngClass]="{'ng-invalid ng-dirty': exercise.get('exercise')?.invalid && (exercise.get('exercise')?.touched || exercise.get('exercise')?.dirty)}"
                                              [virtualScroll]="true" [virtualScrollItemSize]="38">

                                              <!-- Custom filter template to override PrimeNG's filter -->
                                              <ng-template #filter let-options="options">
                                                <input type="text" pInputText placeholder="Filter exercises..."
                                                  [pAutoFocus]="true"
                                                  (input)="onFilterChange($any($event.target).value, i, workoutIndex, exerciseIndex);"
                                                  class="w-full p-2">
                                              </ng-template>
                                            </p-select>
                                            <small class="p-error block mt-1 text-red-400"
                                              *ngIf="exercise.get('exercise')?.invalid && (exercise.get('exercise')?.touched || exercise.get('exercise')?.dirty)">
                                              {{ getNestedErrorMessage(exercise.get('exercise'), 'Exercise selection',
                                              i, workoutIndex, exerciseIndex) }}
                                            </small>
                                          </div>
                                          <div
                                            class="exercise-controls flex justify-content-end align-items-center col-3 md:col-5">
                                            <ng-container *ngIf="!showInputButtons; else desktopControls">
                                              <!-- Mobile Menu -->
                                              <button pButton icon="pi pi-ellipsis-v"
                                                class="p-button-text p-button-rounded" (click)="menu.toggle($event)"
                                                pTooltip="Exercise Options" type="button">
                                              </button>
                                              <p-menu #menu [popup]="true"
                                                [model]="getExerciseMenuItems(i, workoutIndex, exerciseIndex)"></p-menu>
                                            </ng-container>

                                            <ng-template #desktopControls>
                                              <!-- Desktop Buttons Layout -->
                                              <div class="flex align-items-center justify-content-center">
                                                <button pButton icon="pi pi-video"
                                                  class="p-button-text p-button-rounded mr-2"
                                                  (click)="showExerciseVideo(exercise, $event)"
                                                  [disabled]="!exercise.get('exercise')?.value"
                                                  pTooltip="Watch Exercise Demo" type="button">
                                                </button>
                                                <button pButton type="button" icon="pi pi-copy"
                                                  class="p-button-rounded p-button-text mr-1"
                                                  (click)="copyExercise(i, workoutIndex, exerciseIndex)"
                                                  pTooltip="Copy Exercise"></button>
                                                <button pButton type="button" icon="pi pi-clock"
                                                  class="p-button-rounded p-button-text mr-1"
                                                  (click)="openRestTimeDialog(i, workoutIndex, exerciseIndex)"
                                                  pTooltip="Set Rest Time"></button>
                                                <button pButton type="button" icon="pi pi-arrow-up"
                                                  class="p-button-rounded p-button-text mr-1"
                                                  (click)="moveExerciseUp(i, workoutIndex, exerciseIndex)"
                                                  [disabled]="exerciseIndex === 0" pTooltip="Move Up"></button>
                                                <button pButton type="button" icon="pi pi-arrow-down"
                                                  class="p-button-rounded p-button-text mr-1"
                                                  (click)="moveExerciseDown(i, workoutIndex, exerciseIndex)"
                                                  [disabled]="exerciseIndex === getWorkoutExercises(i, workoutIndex).length - 1"
                                                  pTooltip="Move Down"></button>
                                                <button pButton type="button" icon="pi pi-times"
                                                  class="p-button-rounded p-button-danger p-button-text"
                                                  (click)="removeWorkoutExercise(i, workoutIndex, exerciseIndex)"
                                                  [disabled]="getWorkoutExercises(i, workoutIndex).length <= 1"
                                                  pTooltip="Remove Exercise">
                                                </button>
                                              </div>
                                            </ng-template>
                                          </div>
                                        </div>
                                      </div>

                                      <!-- Volume and Intensity Metrics Selection - outside of formArrayName -->
                                      <div class="mb-0">
                                        <div class="grid">
                                          <div class="col-1 flex justify-content-center align-items-center">#</div>
                                          <div class="col-5 flex justify-content-center">
                                            <p-select formControlName="volumeMetric" [options]="volumeMetrics"
                                              optionLabel="title" placeholder="Volume Metric" [filter]="true"
                                              (onChange)="onVolumeMetricChange(i, workoutIndex, exerciseIndex, $event)"></p-select>
                                          </div>
                                          <div class="col-5 flex justify-content-center">
                                            <p-select formControlName="intensityMetric" [options]="intensityMetrics"
                                              optionLabel="title" placeholder="Intensity Metric" [filter]="true"
                                              (onChange)="onIntensityMetricChange(i, workoutIndex, exerciseIndex, $event)"></p-select>
                                          </div>
                                          <div class="col-1"></div>
                                        </div>
                                      </div>
                                      <!-- Sets Section -->
                                      <div formArrayName="sets" class="">


                                        <div
                                          *ngFor="let set of getSets(i, workoutIndex, exerciseIndex).controls; let setIndex = index"
                                          [formGroupName]="setIndex" class="grid align-items-center">
                                          <div class="col-1 flex justify-content-center">{{setIndex + 1}}</div>
                                          <div class="col-5 flex justify-content-center">
                                            <div class="flex align-items-center flex-column" formGroupName="volume">
                                              <div class="flex align-items-center">
                                                <p-inputnumber *ngIf="isVolumeRange(i, workoutIndex, exerciseIndex)"
                                                  formControlName="minimumVolume" [style]="{'width':'5rem'}"
                                                  [inputStyle]="{'width':'100%'}" [showButtons]="showInputButtons"
                                                  [min]="0" [max]="100000"
                                                  [ngClass]="{'ng-invalid ng-dirty': set.get('volume.minimumVolume')?.invalid && (set.get('volume.minimumVolume')?.touched || set.get('volume.minimumVolume')?.dirty)}" />
                                                <span class="mx-1"
                                                  *ngIf="isVolumeRange(i, workoutIndex, exerciseIndex)">-</span>
                                                <p-inputnumber formControlName="maximumVolume"
                                                  [style]="{'width':'5rem'}" [inputStyle]="{'width':'100%'}"
                                                  [showButtons]="showInputButtons" [min]="0" [max]="100000"
                                                  [ngClass]="{'ng-invalid ng-dirty': set.get('volume.maximumVolume')?.invalid && (set.get('volume.maximumVolume')?.touched || set.get('volume.maximumVolume')?.dirty)}" />
                                              </div>
                                              <small class="p-error text-red-400 block mt-1 text-center"
                                                *ngIf="isVolumeRange(i, workoutIndex, exerciseIndex) && set.get('volume.minimumVolume')?.invalid && (set.get('volume.minimumVolume')?.touched || set.get('volume.minimumVolume')?.dirty)">
                                                {{ getErrorMessage(set.get('volume.minimumVolume'), 'Min Volume') }}
                                              </small>
                                              <small class="p-error text-red-400 block mt-1 text-center"
                                                *ngIf="set.get('volume.maximumVolume')?.invalid && (set.get('volume.maximumVolume')?.touched || set.get('volume.maximumVolume')?.dirty)">
                                                {{ getErrorMessage(set.get('volume.maximumVolume'), 'Max Volume') }}
                                              </small>
                                            </div>
                                          </div>
                                          <div class="col-5 flex justify-content-center pr-0">
                                            <div class="flex align-items-center flex-column" formGroupName="intensity">
                                              <div class="flex align-items-center">
                                                <p-inputnumber *ngIf="isIntensityRange(i, workoutIndex, exerciseIndex)"
                                                  formControlName="minimumIntensity" [style]="{'width':'5rem'}"
                                                  [inputStyle]="{'width':'100%'}" [showButtons]="showInputButtons"
                                                  [min]="set.get('intensityMetric')?.value?.minimumIntensity"
                                                  [max]="set.get('intensityMetric')?.value?.maximumIntensity || 10"
                                                  [ngClass]="{'ng-invalid ng-dirty': set.get('intensity.minimumIntensity')?.invalid && (set.get('intensity.minimumIntensity')?.touched || set.get('intensity.minimumIntensity')?.dirty)}" />
                                                <span class="mx-1"
                                                  *ngIf="isIntensityRange(i, workoutIndex, exerciseIndex)">-</span>
                                                <p-inputnumber formControlName="maximumIntensity"
                                                  [style]="{'width':'5rem'}" [inputStyle]="{'width':'100%'}"
                                                  [showButtons]="showInputButtons"
                                                  [min]="set.get('intensityMetric')?.value?.minimumIntensity"
                                                  [max]="set.get('intensityMetric')?.value?.maximumIntensity || 10"
                                                  [ngClass]="{'ng-invalid ng-dirty': set.get('intensity.maximumIntensity')?.invalid && (set.get('intensity.maximumIntensity')?.touched || set.get('intensity.maximumIntensity')?.dirty)}" />
                                              </div>
                                              <small class="p-error text-red-400 block mt-1 text-center"
                                                *ngIf="isIntensityRange(i, workoutIndex, exerciseIndex) && set.get('intensity.minimumIntensity')?.invalid && (set.get('intensity.minimumIntensity')?.touched || set.get('intensity.minimumIntensity')?.dirty)">
                                                {{ getErrorMessage(set.get('intensity.minimumIntensity'), 'Min
                                                Intensity') }}
                                              </small>
                                              <small class="p-error text-red-400 block mt-1 text-center"
                                                *ngIf="set.get('intensity.maximumIntensity')?.invalid && (set.get('intensity.maximumIntensity')?.touched || set.get('intensity.maximumIntensity')?.dirty)">
                                                {{ getErrorMessage(set.get('intensity.maximumIntensity'), 'Max
                                                Intensity') }}
                                              </small>
                                            </div>
                                          </div>
                                          <div class="col-1 flex justify-content-center p-0">
                                            <button pButton type="button" icon="pi pi-times"
                                              class="p-button-rounded p-button-danger p-button-text p-0"
                                              (click)="removeSet(i, workoutIndex, exerciseIndex, setIndex)"
                                              [disabled]="getSets(i, workoutIndex, exerciseIndex).length <= 1"></button>
                                          </div>
                                        </div>

                                        <!-- Add Set Button - Now positioned after all sets -->
                                        <div class="flex justify-content-center mt-3 mb-2">
                                          <button pButton type="button" label="Add Set" icon="pi pi-plus"
                                            class="p-button-sm"
                                            (click)="addSet(i, workoutIndex, exerciseIndex)"></button>
                                        </div>
                                      </div>
                                    </div>
                                  </div>

                                  <!-- Add Exercise Button - Now positioned after all exercises -->
                                  <div class="flex justify-content-center mt-3 mb-3">
                                    <button pButton type="button" label="Add Exercise" icon="pi pi-plus"
                                      class="p-button-outlined" (click)="addWorkoutExercise(i, workoutIndex)"></button>
                                    <button pButton type="button" label="Paste Exercise" icon="pi pi-file-import"
                                      class="p-button-outlined ml-2" (click)="pasteExercise(i, workoutIndex)"
                                      [disabled]="!copiedExercise"></button>
                                  </div>
                                </div>
                              </div>
                            </p-accordion-content>
                          </p-accordion-panel>
                          }
                        </p-accordion>

                        <div class="mb-3 flex justify-content-center mt-3">
                          <button pButton type="button" label="Add Workout" icon="pi pi-plus" class="p-button-outlined"
                            (click)="addWorkout(i)"></button>
                          <button pButton type="button" label="Paste Workout" icon="pi pi-file-import"
                            class="p-button-outlined ml-2" (click)="pasteWorkout(i)"
                            [disabled]="!copiedWorkout"></button>
                        </div>
                      </div>
                    </div>
                  </p-tabpanel>
                </p-tabpanels>
              </p-tabs>

              <div class="flex justify-content-between mt-4">
                <p-button label="Back" icon="pi pi-arrow-left" severity="secondary" styleClass="ml-2"
                  (onClick)="activateCallback(1)"></p-button>
                <p-button label="Next" icon="pi pi-arrow-right" iconPos="right" styleClass="mr-2"
                  (onClick)="handleNextFromStep2(activateCallback)"></p-button>
              </div>
            </ng-template>
          </p-step-panel>


          <!-- Step 3: Review & Create/Update -->
          <p-step-panel [value]="3">
            <ng-template #content let-activateCallback="activateCallback">
              <div class="surface-ground p-0 md:p-4">
                <div class="surface-card p-4 shadow-2 border-round">
                  <h3 class="text-2xl font-semibold mb-4 text-center text-primary">Review Your Program</h3>

                  <!-- Program Details Section -->
                  <div class="grid mb-4">
                    <!-- Program Image (if available) -->
                    <div class="col-12 md:col-4 flex justify-content-center align-items-center mb-3 md:mb-0"
                      *ngIf="imagePreviewUrl || existingImageUrl">
                      <img [src]="imagePreviewUrl || existingImageUrl" alt="Program Image" class="shadow-1 border-round"
                        style="max-width: 100%; max-height: 200px; object-fit: cover;">
                    </div>

                    <!-- Program Name & Description -->
                    <div [class]="(imagePreviewUrl || existingImageUrl) ? 'col-12 md:col-8' : 'col-12'">
                      <div class="mb-3">
                        <span class="text-sm text-600">Program Name</span>
                        <p class="text-xl font-bold text-900 mt-1">{{ programForm.get('name')?.value || 'N/A' }}</p>
                      </div>
                      <div *ngIf="programForm.get('description')?.value">
                        <span class="text-sm text-600">Description</span>
                        <p class="text-md text-700 mt-1 preserve-whitespace">{{ programForm.get('description')?.value
                          }}</p>
                      </div>
                      <div class="mt-2">
                        <span class="text-sm text-600">Visibility: </span>
                        <p-tag [value]="programForm.get('public')?.value ? 'Public' : 'Private'"
                          [severity]="programForm.get('public')?.value ? 'success' : 'info'"></p-tag>
                      </div>
                    </div>
                  </div>


                  <!-- Weeks and Workouts Summary -->
                  <h4 class="text-lg font-semibold mb-3 text-primary">Workout Structure</h4>
                  <div *ngIf="weeks.controls.length > 0; else noWeeks">
                    <div *ngFor="let week of weeks.controls; let weekIndex = index" class="mb-4">
                      <p-fieldset [legend]="'Week ' + (weekIndex + 1)" [toggleable]="true" [collapsed]="weekIndex > 0">
                        <!-- Collapse subsequent weeks by default -->
                        <div *ngIf="getWorkouts(weekIndex).controls.length > 0; else noWorkoutsInWeek">
                          <div *ngFor="let workout of getWorkouts(weekIndex).controls; let workoutIndex = index"
                            class="surface-100 p-3 border-round mb-3 shadow-1">
                            <div class="flex justify-content-between align-items-center mb-2">
                              <div class="font-semibold text-md text-700">
                                <i class="pi pi-calendar-minus mr-2"></i>{{ workout.get('title')?.value || 'Workout '
                                + (workoutIndex + 1) }}
                              </div>
                              <p-badge [value]="getWorkoutExercises(weekIndex, workoutIndex).length + ' Exercises'"
                                severity="info"></p-badge>
                            </div>
                            <ul class="list-none p-0 m-0">
                              <li
                                *ngFor="let exercise of getWorkoutExercises(weekIndex, workoutIndex).controls; let exerciseIndex = index"
                                class="flex align-items-center py-2 border-bottom-1 surface-border last:border-bottom-none">
                                <span class="text-sm text-700 flex-1">{{ getExerciseTitle(weekIndex, workoutIndex,
                                  exerciseIndex) }}</span>
                                <span class="text-sm text-500">({{ getSets(weekIndex, workoutIndex,
                                  exerciseIndex).length }} sets)</span>
                              </li>
                              <li *ngIf="getWorkoutExercises(weekIndex, workoutIndex).controls.length === 0"
                                class="text-sm text-500 py-2">
                                No exercises in this workout.
                              </li>
                            </ul>
                          </div>
                        </div>
                        <ng-template #noWorkoutsInWeek>
                          <div class="text-center text-500 p-3">
                            <i class="pi pi-info-circle mr-2"></i>No workouts defined for this week.
                          </div>
                        </ng-template>
                      </p-fieldset>
                    </div>
                  </div>
                  <ng-template #noWeeks>
                    <div class="text-center text-500 p-3 surface-100 border-round">
                      <i class="pi pi-exclamation-triangle mr-2"></i>No weeks or workouts have been added to this
                      program yet.
                    </div>
                  </ng-template>

                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-content-between mt-5">
                  <p-button label="Back" icon="pi pi-arrow-left" severity="secondary" (onClick)="activateCallback(2)"
                    styleClass="p-button-outlined ml-2"></p-button>
                  <p-button type="submit" [label]="getSubmitButtonText()" icon="pi pi-check" [loading]="loading"
                    styleClass="p-button-raised mr-2"></p-button>
                </div>
              </div>
            </ng-template>
          </p-step-panel>


        </p-step-panels>
      </p-stepper>
    </form>
  </ng-container>

  <!-- Edit Workout Dialog -->
  <p-dialog header="Edit Workout" [(visible)]="editWorkoutDialogVisible" [style]="{width: '500px'}" [modal]="true">
    <div class="p-fluid grid" *ngIf="selectedWeekIndex !== null && selectedWorkoutIndex !== null">
      <div class="field col-12 mb-3">
        <label for="editWorkoutTitle" class="font-bold mr-2">Workout Title</label>
        <input id="editWorkoutTitle" type="text" pInputText [(ngModel)]="editWorkoutTitle" placeholder="Workout Title"
          class="w-full">
      </div>
      <div class="field col-12">
        <label for="editWorkoutDescription" class="font-bold mr-2">Description</label>
        <textarea id="editWorkoutDescription" pTextarea [(ngModel)]="editWorkoutDescription" placeholder="Description"
          class="w-full" rows="3"></textarea>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton label="Cancel" icon="pi pi-times" class="p-button-text"
        (click)="closeWorkoutEditDialog()"></button>
      <button pButton label="Save" icon="pi pi-check" (click)="saveWorkoutChanges()"></button>
    </ng-template>
  </p-dialog>

  <!-- Rest Time Dialog -->
  <p-dialog header="Set Rest Time" [(visible)]="restTimeDialogVisible" [modal]="true">
    <div class="p-fluid" *ngIf="selectedExerciseInfo">
      <div class="field flex mb-3 flex-column">
        <label for="restTimeMin" class="font-bold mr-3 w-full">Minimum Rest Time</label>
        <p-inputnumber id="restTimeMin" [(ngModel)]="editMinRestTime" [showButtons]="true" buttonLayout="horizontal"
          decrementButtonClass="p-button-danger" incrementButtonClass="p-button-success" styleClass="w-full"
          incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus" [min]="0"></p-inputnumber>
      </div>
      <div class="field mb-3 flex flex-column">
        <label for="restTimeMax" class="font-bold mr-3">Maximum Rest Time</label>
        <p-inputnumber id="restTimeMax" [(ngModel)]="editMaxRestTime" [showButtons]="true" buttonLayout="horizontal"
          decrementButtonClass="p-button-danger" incrementButtonClass="p-button-success"
          incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus" [min]="0"></p-inputnumber>
      </div>
      <div class="field flex flex-column overflow-visible">
        <label for="restTimeMetric" class="font-bold mr-3">Time Unit</label>
        <p-select id="restTimeMetric" [options]="restTimeMetrics" [(ngModel)]="editRestTimeMetric"
          styleClass="overflow-visible" appendTo="body"></p-select>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="closeRestTimeDialog()"></button>
      <button pButton label="Save" icon="pi pi-check" (click)="saveRestTimeChanges()"></button>
    </ng-template>
  </p-dialog>
  <p-dialog header="Exercise Demonstration" [(visible)]="showVideoDialog" [style]="{width: '90vw', maxWidth: '800px'}"
    [modal]="true">
    <div class="p-fluid">
      <div class="video-container" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
        <iframe *ngIf="currentVideoUrl" [src]="currentVideoUrl | safe: 'resourceUrl'"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen>
        </iframe>
      </div>
      <div *ngIf="!currentVideoUrl" class="text-center p-4">
        <p>No video available for this exercise.</p>
      </div>
    </div>
  </p-dialog>

  <p-toast [position]="toastsPositionService.getPosition()"></p-toast>
</div>