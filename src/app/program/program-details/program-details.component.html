<div class="surface-card p-4 shadow-2 border-round">
    <div *ngIf="loading" class="flex justify-content-center">
      <p-progressSpinner></p-progressSpinner>
    </div>
  
    <div *ngIf="!loading && program">
      <!-- Program Header -->
      <div class="flex flex-column md:flex-row align-items-start mb-5">
        <div class="md:w-4 flex justify-content-center md:justify-content-start mb-3 md:mb-0">
          <img [src]="program.id ? apiUrl+ '/'+ program.id + '/image' : 'dinja.jpg'" 
            alt="Program Image" class="w-20rem h-12rem border-round shadow-2">
        </div>
        <div class="md:w-8 md:pl-5">
          <div class="flex justify-content-between align-items-center">
            <h1 class="text-3xl font-bold m-0">{{program.name}}</h1>
            <div class="flex">
              <button pButton icon="pi pi-pencil" label="Edit Program" class="p-button-outlined mr-2" 
                      (click)="editProgram()"></button>
              <button pButton icon="pi pi-file-export" label="Export" class="p-button-outlined mr-2" 
                      (click)="exportProgramData()"></button>
              <p-confirmPopup></p-confirmPopup>
              <button pButton icon="pi pi-trash" label="Delete" class="p-button-outlined p-button-danger" 
                      (click)="confirmDelete($event)"></button>
            </div>
          </div>
          <div class="mt-3 flex align-items-center">
            <span class="text-600">Created by: {{program.creator?.name || 'Unknown'}}</span>
          </div>
          <div class="mt-2 flex align-items-center">
            <p-rating [ngModel]="program.rating" [readonly]="true"></p-rating>
            <span class="ml-2">{{program.rating || 'Not rated'}}</span>
          </div>
        </div>
      </div>
  
      <!-- Program Overview -->
      <p-panel header="Program Overview" [toggleable]="true" styleClass="mb-3">
        <div class="grid">
          <div class="col-12 md:col-3">
            <div class="text-lg font-medium">Duration</div>
            <div class="text-xl font-bold">{{program.weeks?.length || 0}} Weeks</div>
          </div>
          <div class="col-12 md:col-3">
            <div class="text-lg font-medium">Workouts</div>
            <div class="text-xl font-bold">{{getTotalWorkouts()}} Sessions</div>
          </div>
          <div class="col-12 md:col-3">
            <div class="text-lg font-medium">Total Exercises</div>
            <div class="text-xl font-bold">{{getTotalExercises()}} Exercises</div>
          </div>
          <div class="col-12 md:col-3">
            <div class="text-lg font-medium">Total Sets</div>
            <div class="text-xl font-bold">{{getTotalSets()}} Sets</div>
          </div>
        </div>
      </p-panel>
  
      <!-- Weeks Section with Tabs -->
      <div class="col-12">
        <div class="flex justify-content-end mb-2">
          <button pButton type="button" label="Print Program" icon="pi pi-print" class="p-button-outlined"
            (click)="printProgram()"></button>
        </div>
  
        <p-tabs [value]="activeWeekTab">
          <p-tablist>
            @for (week of program.weeks; track $index) {
            <p-tab [value]="$index.toString()">Week {{ $index + 1 }}</p-tab>
            }
          </p-tablist>
  
          <p-tabpanels>
            @for (week of program.weeks; track $index) {
            <p-tabpanel [value]="$index.toString()">
              <div class="p-3">
                <div class="flex justify-content-between align-items-center mb-3">
                  <h3 class="m-0">Week {{ $index + 1 }}</h3>
                </div>
  
                <!-- Workouts for this Week -->
                <p-accordion>
                  @for (workout of week.workouts; track workout; let workoutIndex = $index) {
                  <p-accordion-panel value="{{workoutIndex}}">
                    <p-accordion-header>{{workout.title || 'Workout ' + (workoutIndex + 1)}}</p-accordion-header>
                    <p-accordion-content>
                      <div class="p-3">
                        <div class="flex justify-content-between align-items-center mb-3">
                          <div class="p-fluid grid">
                            <div class="field col-12 md:col-4">
                              <label class="font-bold">Title</label>
                              <div class="p-inputtext p-component p-filled p-disabled">{{workout.title}}</div>
                            </div>
                            <div class="field col-12 md:col-4">
                              <label class="font-bold">Number/Day</label>
                              <div class="p-inputtext p-component p-filled p-disabled">{{workout.number || 'Day ' + (workoutIndex + 1)}}</div>
                            </div>
                            <div class="field col-12 md:col-4">
                              <label class="font-bold">Description</label>
                              <div class="p-inputtext p-component p-filled p-disabled min-h-4rem">{{workout.description || 'No description available.'}}</div>
                            </div>
                          </div>
                        </div>
  
                        <!-- Exercises for this Workout -->
                        <div>
                          <p-divider align="left">
                            <span class="p-tag p-tag-info">Exercises</span>
                          </p-divider>
  
                          @for (exercise of workout.workoutExercises; track exercise; let exerciseIndex = $index) {
                          <div class="p-3 border-round mb-3 surface-100">
                            <div class="flex justify-content-between align-items-center mb-3">
                              <h4 class="m-0">Exercise {{ exerciseIndex + 1 }}: {{exercise.exercise?.title}}</h4>
                              <button pButton type="button" icon="pi pi-chevron-down"
                                class="p-button-rounded p-button-text"
                                (click)="toggleExerciseDetails(workout.id, exercise.id)"></button>
                            </div>
  
                            <div class="grid">
                              <div class="col-12 md:col-6">
                                <label class="font-bold">Volume Metric</label>
                                <div class="p-inputtext p-component p-filled p-disabled">{{exercise.workoutExerciseSets[0]?.volumeMetric?.title || 'N/A'}}</div>
                              </div>
                              <div class="col-12 md:col-6">
                                <label class="font-bold">Intensity Metric</label>
                                <div class="p-inputtext p-component p-filled p-disabled">{{exercise.workoutExerciseSets[0]?.intensityMetric?.title || 'N/A'}}</div>
                              </div>
                            </div>
  
                            <!-- Sets for this Exercise -->
                            <div *ngIf="isExerciseExpanded(workout.id, exercise.id)">
                              <p-divider align="left">
                                <span class="p-tag p-tag-success">Sets</span>
                              </p-divider>
  
                              <div class="grid">
                                <div class="col-12 md:col-6 lg:col-3 font-bold">Set</div>
                                <div class="col-12 md:col-6 lg:col-4 font-bold">Volume</div>
                                <div class="col-12 md:col-6 lg:col-4 font-bold">Intensity</div>
                                <div class="col-12 md:col-6 lg:col-1 font-bold">Rest</div>
                              </div>
  
                              @for (set of exercise.workoutExerciseSets; track set; let setIndex = $index) {
                              <div class="grid align-items-center mb-2">
                                <div class="col-12 md:col-6 lg:col-3">
                                  Set {{ setIndex + 1 }}
                                </div>
                                <div class="col-12 md:col-6 lg:col-4">
                                  <!-- Volume display -->
                                  <div class="flex align-items-center">
                                    <ng-container *ngIf="isVolumeRange(set)">
                                      {{set.volume.minimumVolume}} - {{set.volume.maximumVolume}}
                                    </ng-container>
                                    <ng-container *ngIf="!isVolumeRange(set)">
                                      {{set.volume.maximumVolume}}
                                    </ng-container>
                                    <span class="ml-2">{{set.volumeMetric?.metricSymbol}}</span>
                                  </div>
                                </div>
                                <div class="col-12 md:col-6 lg:col-4">
                                  <!-- Intensity display -->
                                  <div class="flex align-items-center">
                                    <ng-container *ngIf="isIntensityRange(set)">
                                      {{set.intensity.minimumIntensity}} - {{set.intensity.maximumIntensity}}
                                    </ng-container>
                                    <ng-container *ngIf="!isIntensityRange(set)">
                                      {{set.intensity.maximumIntensity}}
                                    </ng-container>
                                    <span class="ml-2">{{set.intensityMetric?.metricSymbol}}</span>
                                  </div>
                                </div>
                                <div class="col-12 md:col-6 lg:col-1">
                                  {{ 60}}s
                                </div>
                              </div>
                              }
                            </div>
                          </div>
                          }
                        </div>
                      </div>
                    </p-accordion-content>
                  </p-accordion-panel>
                  }
                </p-accordion>
              </div>
            </p-tabpanel>
            }
          </p-tabpanels>
        </p-tabs>
      </div>
    </div>
  
    <!-- No Program Found -->
    <div *ngIf="!loading && !program" class="text-center p-5">
      <i class="pi pi-exclamation-triangle text-5xl text-yellow-500 mb-3"></i>
      <h2>Program Not Found</h2>
      <p>The requested program could not be found or you don't have permission to view it.</p>
      <button pButton label="Back to Programs" icon="pi pi-arrow-left" class="p-button-outlined mt-3" routerLink="/programs"></button>
    </div>
  </div>
  
  <p-toast></p-toast>